# 🤖 CB價格自動更新設置指南

## ✨ 功能說明

設置完成後，系統會：
- ✅ 每天下午2點自動執行（台股收盤後）
- ✅ 自動抓取所有CB的最新價格
- ✅ 自動更新到網站上
- ✅ 完全免費，不需要任何操作

**你只需要設置一次，之後完全自動！**

---

## 📋 設置步驟（5分鐘）

### 步驟1：上傳專案到GitHub

```bash
# 在專案資料夾執行
git init
git add .
git commit -m "初始化CB查詢工具"
git remote add origin https://github.com/你的用戶名/cb-tools.git
git branch -M main
git push -u origin main
```

### 步驟2：啟用GitHub Actions

1. 進入你的GitHub Repository
2. 點選 "Settings" (設定)
3. 左側選單點選 "Actions" → "General"
4. 找到 "Workflow permissions"
5. 選擇 "Read and write permissions"
6. 點選 "Save"

**完成！** GitHub Actions已啟用

### 步驟3：測試自動更新

#### 方法A：手動觸發測試

1. 進入GitHub Repository
2. 點選 "Actions" 標籤
3. 左側選擇 "自動更新CB價格"
4. 右上角點選 "Run workflow"
5. 點選綠色的 "Run workflow" 按鈕

等待1-2分鐘，你會看到：
- ✅ 綠色勾勾 = 成功
- ❌ 紅色叉叉 = 需要檢查

#### 方法B：等待自動執行

- 每天下午2點會自動執行
- 不需要任何操作

---

## 📊 檢查更新狀態

### 查看執行記錄

1. GitHub Repository → Actions
2. 看到 "自動更新CB價格" 的執行記錄
3. 點進去可以看詳細log

### 查看更新的資料

```bash
# 檢查是否有新的價格檔案
ls -l data/prices/

# 應該會看到:
# cb_prices_20251030.json  <- 每日價格
# latest.json              <- 最新價格(網頁用)
```

---

## 🌐 網頁自動讀取價格

網頁會自動從 `data/prices/latest.json` 讀取最新價格

### 在網頁中使用：

```javascript
// 自動載入最新CB價格
async function loadLatestPrices() {
    try {
        const response = await fetch('../data/prices/latest.json');
        const data = await response.json();
        
        console.log(`最後更新: ${data.update_time}`);
        console.log(`CB數量: ${data.count}`);
        
        // 顯示價格
        displayPrices(data.data);
        
    } catch (error) {
        console.error('載入價格失敗:', error);
        // 使用週報的資料作為備用
    }
}

// 網頁載入時執行
window.onload = loadLatestPrices;
```

---

## ⚙️ 自訂設定

### 修改執行時間

編輯 `.github/workflows/update-prices.yml`:

```yaml
schedule:
  # 改成你要的時間（使用UTC時間）
  - cron: '0 6 * * 1-5'  # UTC 6:00 = 台北 14:00
  
  # 其他時間範例：
  # - cron: '0 2 * * 1-5'  # 台北 10:00
  # - cron: '30 7 * * 1-5' # 台北 15:30
```

### 修改抓取來源

編輯 `scripts/fetch_cb_prices.py`:

```python
# 只抓證交所
def main():
    twse_data = fetch_twse_cb_data()
    save_cb_prices(twse_data)

# 或只抓櫃買中心
def main():
    tpex_data = fetch_tpex_cb_data()
    save_cb_prices(tpex_data)
```

---

## 🔧 疑難排解

### 問題1: Actions執行失敗

**檢查項目：**
1. Workflow permissions是否已開啟
2. 網路是否能連到證交所
3. 查看詳細錯誤訊息

**解決方式：**
```bash
# 本地測試腳本
python3 scripts/fetch_cb_prices.py

# 如果成功，問題可能在GitHub設定
```

### 問題2: 網頁讀不到價格

**檢查項目：**
1. data/prices/latest.json 是否存在
2. 檔案內容是否正確
3. 網頁路徑是否正確

**解決方式：**
```bash
# 檢查檔案
cat data/prices/latest.json

# 手動建立測試檔案
cp data/prices/latest.json web/test-prices.json
```

### 問題3: 某些CB抓不到價格

**可能原因：**
- CB當天沒有交易
- CB代碼格式不同
- CB在不同市場（上市/上櫃）

**解決方式：**
- 系統會自動跳過沒交易的CB
- 價格為null時使用上次資料
- 兩個市場都會抓取

---

## 📈 進階功能

### 功能1: 歷史價格查詢

所有每日價格都會保存：

```
data/prices/
├── cb_prices_20251027.json
├── cb_prices_20251028.json
├── cb_prices_20251029.json
├── cb_prices_20251030.json
└── latest.json
```

可以用來：
- 製作價格走勢圖
- 分析歷史波動
- 計算技術指標

### 功能2: 價格警示

```python
# 在 fetch_cb_prices.py 加入
def check_price_alerts(cb_data):
    for cb in cb_data:
        # 漲幅超過5%
        if cb['change_percent'] > 5:
            send_notification(f"{cb['name']} 大漲 {cb['change_percent']}%")
        
        # 跌幅超過5%
        if cb['change_percent'] < -5:
            send_notification(f"{cb['name']} 大跌 {cb['change_percent']}%")
```

### 功能3: 匯出Excel報表

```python
# 自動產生Excel報表
import pandas as pd

def export_daily_report():
    with open('data/prices/latest.json') as f:
        data = json.load(f)
    
    df = pd.DataFrame(data['data'])
    df.to_excel(f'reports/CB價格_{data["date"]}.xlsx', index=False)
```

---

## 💡 最佳實踐

### 1. 每週檢查一次

確認自動更新正常運作：
- 查看GitHub Actions執行記錄
- 檢查最新價格檔案
- 測試網頁顯示

### 2. 保留歷史資料

定期備份 data/prices/ 資料夾：
```bash
# 每月備份一次
tar -czf cb_prices_backup_$(date +%Y%m).tar.gz data/prices/
```

### 3. 監控執行狀況

GitHub會發送失敗通知到你的Email

---

## 🎯 總結

設置完成後，你的工作流程變成：

**以前（每天要做）：**
❌ 下載Excel
❌ 解析資料
❌ 上傳更新

**現在（完全自動）：**
✅ 系統自動抓取
✅ 系統自動更新
✅ 你只要看結果

**你只需要：**
📝 每週上傳一次週報資料（成交量排行等）
💰 價格完全自動更新

---

## 📞 需要幫助？

如果遇到問題：
1. 查看 GitHub Actions 的執行log
2. 檢查 data/prices/ 資料夾
3. 測試本地執行腳本

**預祝設置順利！** 🎉
