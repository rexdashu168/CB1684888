<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…ƒå¤§å¯è½‰å‚µè³‡æ–™æŸ¥è©¢ç³»çµ±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .upload-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 2px solid #e9ecef;
        }

        .upload-box {
            display: flex;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        .file-input-wrapper {
            position: relative;
            overflow: hidden;
            display: inline-block;
        }

        .file-input-wrapper input[type=file] {
            position: absolute;
            left: -9999px;
        }

        .file-input-label {
            background: #667eea;
            color: white;
            padding: 12px 30px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-block;
            font-weight: bold;
        }

        .file-input-label:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .file-name {
            color: #495057;
            font-size: 14px;
        }

        .update-time {
            margin-left: auto;
            color: #6c757d;
            font-size: 14px;
        }

        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            overflow-x: auto;
        }

        .tab {
            padding: 15px 25px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 16px;
            font-weight: 500;
            color: #6c757d;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .tab:hover {
            background: #e9ecef;
            color: #495057;
        }

        .tab.active {
            background: white;
            color: #667eea;
            border-bottom: 3px solid #667eea;
        }

        .tab-content {
            display: none;
            padding: 30px;
        }

        .tab-content.active {
            display: block;
        }

        .filters {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-group label {
            font-weight: 600;
            margin-bottom: 5px;
            color: #495057;
            font-size: 14px;
        }

        .filter-group input,
        .filter-group select {
            padding: 10px;
            border: 1px solid #ced4da;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .filter-group input:focus,
        .filter-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-buttons {
            grid-column: 1 / -1;
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .btn {
            padding: 10px 25px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
            font-size: 14px;
        }

        .btn-primary {
            background: #667eea;
            color: white;
        }

        .btn-primary:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            font-size: 14px;
            white-space: nowrap;
        }

        td {
            padding: 12px 10px;
            border-bottom: 1px solid #e9ecef;
            font-size: 14px;
        }

        tbody tr:hover {
            background: #f8f9fa;
        }

        .positive {
            color: #dc3545;
        }

        .negative {
            color: #28a745;
        }

        .highlight {
            background: #fff3cd !important;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .stat-card h3 {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-card .change {
            font-size: 14px;
            opacity: 0.8;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-warning {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            color: #856404;
        }

        .alert-info {
            background: #d1ecf1;
            border-left: 4px solid #17a2b8;
            color: #0c5460;
        }

        .no-data {
            text-align: center;
            padding: 50px;
            color: #6c757d;
        }

        .loading {
            text-align: center;
            padding: 50px;
            color: #667eea;
            font-size: 18px;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .tabs {
                flex-wrap: nowrap;
            }

            .filters {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š å…ƒå¤§å¯è½‰å‚µè³‡æ–™æŸ¥è©¢ç³»çµ±</h1>
            <p>æä¾›å³æ™‚å¯è½‰å‚µå ±åƒ¹ã€è´–å›è³‡è¨Šã€æµé€šé¤˜é¡ç­‰å®Œæ•´æŸ¥è©¢åŠŸèƒ½</p>
        </div>

        <div class="upload-section">
            <div class="upload-box">
                <div class="file-input-wrapper">
                    <label class="file-input-label" for="file-upload">
                        ğŸ“ é¸æ“‡æ¯é€±CBè³‡æ–™åº«
                    </label>
                    <input type="file" id="file-upload" accept=".xlsx,.xls">
                </div>
                <span class="file-name" id="file-name">å°šæœªé¸æ“‡æª”æ¡ˆ</span>
                
                <div class="file-input-wrapper" style="margin-left: 20px;">
                    <label class="file-input-label" for="file-upload-primary">
                        ğŸ“ é¸æ“‡CBç™¼è¡Œæ¡ˆä»¶å½™æ•´
                    </label>
                    <input type="file" id="file-upload-primary" accept=".xlsx,.xls">
                </div>
                <span class="file-name" id="file-name-primary">å°šæœªé¸æ“‡æª”æ¡ˆ</span>
                
                <span class="update-time" id="update-time"></span>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" data-tab="quote">å³æ™‚å ±åƒ¹</button>
            <button class="tab" data-tab="primary">åˆç´šå¸‚å ´</button>
            <button class="tab" data-tab="issued">å·²ç™¼è¡Œæ¡ˆä»¶</button>
            <button class="tab" data-tab="filter">é€²éšç¯©é¸</button>
            <button class="tab" data-tab="redeem">è´–å›è³‡è¨Š</button>
            <button class="tab" data-tab="stop">åœæ­¢è½‰æ›</button>
            <button class="tab" data-tab="balance">æµé€šé¤˜é¡</button>
            <button class="tab" data-tab="adjust">åƒ¹æ ¼èª¿æ•´</button>
            <button class="tab" data-tab="daily">æ¯æ—¥è¡Œæƒ…</button>
        </div>

        <!-- å³æ™‚å ±åƒ¹ -->
        <div id="quote" class="tab-content active">
            <div class="stats-grid" id="stats-grid"></div>
            <div class="table-wrapper">
                <table id="quote-table">
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>åç¨±</th>
                            <th>ç”¢æ¥­</th>
                            <th>æ¬Šåˆ©é‡‘</th>
                            <th>è½‰æ›åƒ¹æ ¼</th>
                            <th>CBåƒè€ƒåƒ¹</th>
                            <th>æº¢æŠ˜åƒ¹%</th>
                            <th>å‰©é¤˜å¹´æœŸ</th>
                            <th>åˆ°æœŸæ—¥</th>
                            <th>ä¿¡è©•</th>
                        </tr>
                    </thead>
                    <tbody id="quote-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- åˆç´šå¸‚å ´ -->
        <div id="primary" class="tab-content">
            <div class="alert alert-info">
                <span>ğŸ’¡</span>
                <div>
                    <strong>åˆç´šå¸‚å ´è³‡è¨Šï¼š</strong>å³å°‡ç™¼è¡Œæˆ–æ­£åœ¨è©¢åœˆ/ç«¶æ‹çš„å¯è½‰å‚µæ¡ˆä»¶
                </div>
            </div>
            <div class="table-wrapper">
                <table id="primary-table">
                    <thead>
                        <tr>
                            <th>æ¨™çš„ä»£è™Ÿ</th>
                            <th>ç™¼è¡Œæ¨™çš„</th>
                            <th>è©¢åœˆ/ç«¶æ‹</th>
                            <th>TCRI/æ“”ä¿</th>
                            <th>ç™¼è¡Œé‡(å„„)</th>
                            <th>ä¸»è¾¦åˆ¸å•†</th>
                            <th>ç”Ÿæ•ˆæ—¥</th>
                            <th>è©¢åœˆ/æŠ•æ¨™æœŸé–“</th>
                            <th>æº¢åƒ¹ç‡</th>
                            <th>è½‰æ›åƒ¹æ ¼</th>
                            <th>æ›ç‰Œæ—¥</th>
                            <th>æ‰¿éŠ·åƒ¹æ ¼</th>
                            <th>å¹´æœŸ</th>
                            <th>è³£å›æ¢ä»¶</th>
                            <th>å‚™è¨»</th>
                        </tr>
                    </thead>
                    <tbody id="primary-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- å·²ç™¼è¡Œæ¡ˆä»¶ -->
        <div id="issued" class="tab-content">
            <div class="alert alert-info">
                <span>ğŸ“‹</span>
                <div>
                    <strong>æ­·å²ç™¼è¡Œè¨˜éŒ„ï¼š</strong>å·²å®Œæˆç™¼è¡Œçš„å¯è½‰å‚µæ¡ˆä»¶è³‡æ–™
                </div>
            </div>
            <div class="table-wrapper">
                <table id="issued-table">
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>ç™¼è¡Œæ¨™çš„</th>
                            <th>TCRI/æ“”ä¿</th>
                            <th>é¡åº¦(å„„)</th>
                            <th>ä¸»è¾¦åˆ¸å•†</th>
                            <th>é€ä»¶æ—¥</th>
                            <th>ç”Ÿæ•ˆæ—¥</th>
                            <th>è©¢åœˆæœŸé–“</th>
                            <th>æº¢åƒ¹ç‡</th>
                            <th>è½‰æ›åƒ¹æ ¼</th>
                            <th>æ›ç‰Œæ—¥æœŸ</th>
                            <th>æ‰¿éŠ·åƒ¹æ ¼</th>
                            <th>å¹´æœŸ</th>
                            <th>è³£å›æ¢ä»¶</th>
                        </tr>
                    </thead>
                    <tbody id="issued-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- é€²éšç¯©é¸ -->
        <div id="filter" class="tab-content">
            <div class="filters">
                <div class="filter-group">
                    <label>ç”¢æ¥­</label>
                    <select id="filter-industry">
                        <option value="">å…¨éƒ¨ç”¢æ¥­</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>æº¢æŠ˜åƒ¹% (æœ€å°)</label>
                    <input type="number" id="filter-premium-min" placeholder="ä¾‹: -10">
                </div>
                <div class="filter-group">
                    <label>æº¢æŠ˜åƒ¹% (æœ€å¤§)</label>
                    <input type="number" id="filter-premium-max" placeholder="ä¾‹: 50">
                </div>
                <div class="filter-group">
                    <label>å‰©é¤˜å¹´æœŸ (æœ€å°)</label>
                    <input type="number" step="0.1" id="filter-years-min" placeholder="ä¾‹: 0.5">
                </div>
                <div class="filter-group">
                    <label>å‰©é¤˜å¹´æœŸ (æœ€å¤§)</label>
                    <input type="number" step="0.1" id="filter-years-max" placeholder="ä¾‹: 3">
                </div>
                <div class="filter-group">
                    <label>ä¿¡ç”¨è©•ç­‰</label>
                    <select id="filter-rating">
                        <option value="">å…¨éƒ¨è©•ç­‰</option>
                    </select>
                </div>
                <div class="filter-buttons">
                    <button class="btn btn-primary" onclick="applyFilters()">å¥—ç”¨ç¯©é¸</button>
                    <button class="btn btn-secondary" onclick="resetFilters()">é‡è¨­</button>
                </div>
            </div>
            <div class="table-wrapper">
                <table id="filter-table">
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>åç¨±</th>
                            <th>ç”¢æ¥­</th>
                            <th>CBåƒè€ƒåƒ¹</th>
                            <th>è½‰æ›åƒ¹æ ¼</th>
                            <th>æº¢æŠ˜åƒ¹%</th>
                            <th>å‰©é¤˜å¹´æœŸ</th>
                            <th>æ³¢å‹•ç‡120å¤©</th>
                            <th>æ³¢å‹•ç‡240å¤©</th>
                            <th>ä¿¡è©•</th>
                        </tr>
                    </thead>
                    <tbody id="filter-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- è´–å›è³‡è¨Š -->
        <div id="redeem" class="tab-content">
            <div class="alert alert-warning">
                <span>âš ï¸</span>
                <div>
                    <strong>é‡è¦æé†’ï¼š</strong>ä»¥ä¸‹ç‚ºå…¬å¸å·²åŸ·è¡Œæˆ–å³å°‡åŸ·è¡Œè´–å›æ¬Šçš„å¯è½‰å‚µ,è«‹æ³¨æ„ASOåˆ°æœŸæ—¥
                </div>
            </div>
            <div class="table-wrapper">
                <table id="redeem-table">
                    <thead>
                        <tr>
                            <th>å…¬å¸ä»£è™Ÿ</th>
                            <th>å…¬å¸åç¨±</th>
                            <th>ç”³å ±æ—¥æœŸ</th>
                            <th>ASOåˆ°æœŸæ—¥</th>
                            <th>ä¸»æ—¨</th>
                        </tr>
                    </thead>
                    <tbody id="redeem-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- åœæ­¢è½‰æ› -->
        <div id="stop" class="tab-content">
            <div class="alert alert-info">
                <span>â„¹ï¸</span>
                <div>
                    <strong>åœæ­¢è½‰æ›æœŸé–“ï¼š</strong>ä»¥ä¸‹å¯è½‰å‚µåœ¨æŒ‡å®šæœŸé–“ç„¡æ³•é€²è¡Œè½‰æ›
                </div>
            </div>
            <div class="table-wrapper">
                <table id="stop-table">
                    <thead>
                        <tr>
                            <th>å‚µåˆ¸ä»£ç¢¼</th>
                            <th>å‚µåˆ¸ç°¡ç¨±</th>
                            <th>åœæ­¢è½‰æ›èµ·æ—¥</th>
                            <th>åœæ­¢è½‰æ›è¿„æ—¥</th>
                            <th>åœæ­¢è½‰æ›äº‹ç”±</th>
                        </tr>
                    </thead>
                    <tbody id="stop-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- æµé€šé¤˜é¡ -->
        <div id="balance" class="tab-content">
            <div class="table-wrapper">
                <table id="balance-table">
                    <thead>
                        <tr>
                            <th>è­‰åˆ¸ä»£è™Ÿ</th>
                            <th>è­‰åˆ¸åç¨±</th>
                            <th>æœ¬é€±è‚¡é¡</th>
                            <th>ä¸Šé€±è‚¡é¡</th>
                            <th>å¢æ¸›æ•¸é¡</th>
                            <th>å¢æ¸›æ¯”ç‡%</th>
                            <th>å‰©é¤˜æ¯”ç‡%</th>
                        </tr>
                    </thead>
                    <tbody id="balance-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- åƒ¹æ ¼èª¿æ•´ -->
        <div id="adjust" class="tab-content">
            <div class="alert alert-warning">
                <span>âš ï¸</span>
                <div>
                    <strong>è½‰æ›åƒ¹æ ¼èª¿æ•´ï¼š</strong>ä»¥ä¸‹å¯è½‰å‚µçš„è½‰æ›åƒ¹æ ¼å·²èª¿æ•´æˆ–å³å°‡èª¿æ•´
                </div>
            </div>
            <div class="table-wrapper">
                <table id="adjust-table">
                    <thead>
                        <tr>
                            <th>å…¬å¸ä»£è™Ÿ</th>
                            <th>å…¬å¸åç¨±</th>
                            <th>èª¿æ•´è³‡è¨Š</th>
                        </tr>
                    </thead>
                    <tbody id="adjust-tbody"></tbody>
                </table>
            </div>
        </div>

        <!-- æ¯æ—¥è¡Œæƒ… -->
        <div id="daily" class="tab-content">
            <div class="table-wrapper">
                <table id="daily-table">
                    <thead>
                        <tr>
                            <th>ä»£ç¢¼</th>
                            <th>åç¨±</th>
                            <th>ç”¢æ¥­</th>
                            <th>CBæ”¶ç›¤åƒ¹</th>
                            <th>æˆäº¤é‡</th>
                            <th>è‚¡åƒ¹</th>
                            <th>è½‰æ›åƒ¹æ ¼</th>
                            <th>è½‰æ›åƒ¹å€¼</th>
                            <th>æº¢æŠ˜åƒ¹%</th>
                            <th>YTM</th>
                            <th>TCRI</th>
                        </tr>
                    </thead>
                    <tbody id="daily-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let workbookData = {};
        let primaryData = {};
        let currentData = {};

        // æ¯é€±CBè³‡æ–™åº«æª”æ¡ˆä¸Šå‚³è™•ç†
        document.getElementById('file-upload').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('file-name').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    workbookData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        workbookData[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {
                            raw: false,
                            defval: ''
                        });
                    });

                    updateTime();
                    loadAllData();
                } catch (error) {
                    alert('æª”æ¡ˆè®€å–å¤±æ•—: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        // CBç™¼è¡Œæ¡ˆä»¶å½™æ•´æª”æ¡ˆä¸Šå‚³è™•ç†
        document.getElementById('file-upload-primary').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;

            document.getElementById('file-name-primary').textContent = file.name;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    
                    primaryData = {};
                    workbook.SheetNames.forEach(sheetName => {
                        primaryData[sheetName] = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName], {
                            raw: false,
                            defval: ''
                        });
                    });

                    updateTime();
                    loadPrimaryData();
                } catch (error) {
                    alert('æª”æ¡ˆè®€å–å¤±æ•—: ' + error.message);
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function updateTime() {
            const now = new Date();
            document.getElementById('update-time').textContent = 
                `æ›´æ–°æ™‚é–“: ${now.toLocaleString('zh-TW')}`;
        }

        // Tabåˆ‡æ›
        document.querySelectorAll('.tab').forEach(tab => {
            tab.addEventListener('click', function() {
                const tabName = this.dataset.tab;
                
                document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                
                this.classList.add('active');
                document.getElementById(tabName).classList.add('active');
            });
        });

        function loadAllData() {
            if (!workbookData['å ±åƒ¹å–®']) {
                alert('æ‰¾ä¸åˆ°å ±åƒ¹å–®å·¥ä½œè¡¨');
                return;
            }

            currentData.quote = workbookData['å ±åƒ¹å–®'].filter(row => row['å¯è½‰å‚µåç¨±']);
            currentData.basic = workbookData['åŸºæœ¬è³‡æ–™æª”'] || [];
            currentData.redeem = workbookData['å…¬å¸åŸ·è¡Œè´–å›æ¬Š'] || [];
            currentData.stop = workbookData['åœæ­¢è½‰æ›è³‡è¨Š'] || [];
            currentData.balance = workbookData['CBæµé€šåœ¨å¤–é¤˜é¡'] || [];
            currentData.adjust = workbookData['è½‰æ›åƒ¹æ ¼èª¿æ•´'] || [];
            currentData.daily = workbookData['CBæ¯æ—¥è¡Œæƒ…è¡¨'] || [];

            loadQuoteTable();
            loadRedeemTable();
            loadStopTable();
            loadBalanceTable();
            loadAdjustTable();
            loadDailyTable();
            loadFilterOptions();
            loadStats();
        }

        function loadPrimaryData() {
            if (!primaryData['ç™¼è¡Œæ¡ˆä»¶']) {
                alert('æ‰¾ä¸åˆ°ç™¼è¡Œæ¡ˆä»¶å·¥ä½œè¡¨');
                return;
            }

            loadPrimaryTable();
            loadIssuedTable();
        }

        function loadStats() {
            if (!currentData.quote || currentData.quote.length === 0) return;

            const totalCB = currentData.quote.length;
            const avgPremium = currentData.quote.reduce((sum, row) => {
                const premium = parseFloat(row['æº¢(æŠ˜)åƒ¹%']) || 0;
                return sum + premium;
            }, 0) / totalCB;

            const positiveCount = currentData.quote.filter(row => {
                const premium = parseFloat(row['æº¢(æŠ˜)åƒ¹%']) || 0;
                return premium > 0;
            }).length;

            const negativeCount = totalCB - positiveCount;

            const statsHTML = `
                <div class="stat-card">
                    <h3>å¯è½‰å‚µç¸½æ•¸</h3>
                    <div class="value">${totalCB}</div>
                    <div class="change">æª”</div>
                </div>
                <div class="stat-card">
                    <h3>å¹³å‡æº¢æŠ˜åƒ¹</h3>
                    <div class="value">${avgPremium.toFixed(2)}%</div>
                    <div class="change">å…¨å¸‚å ´å¹³å‡</div>
                </div>
                <div class="stat-card">
                    <h3>æº¢åƒ¹äº¤æ˜“</h3>
                    <div class="value">${positiveCount}</div>
                    <div class="change">æª” (${(positiveCount/totalCB*100).toFixed(1)}%)</div>
                </div>
                <div class="stat-card">
                    <h3>æŠ˜åƒ¹äº¤æ˜“</h3>
                    <div class="value">${negativeCount}</div>
                    <div class="change">æª” (${(negativeCount/totalCB*100).toFixed(1)}%)</div>
                </div>
            `;

            document.getElementById('stats-grid').innerHTML = statsHTML;
        }

        function loadQuoteTable() {
            const tbody = document.getElementById('quote-tbody');
            if (!currentData.quote || currentData.quote.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">å°šæœªè¼‰å…¥è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.quote.map(row => {
                const premium = parseFloat(row['æº¢(æŠ˜)åƒ¹%']) || 0;
                const premiumClass = premium >= 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td>${row['å¯è½‰å‚µä»£ç¢¼'] || '-'}</td>
                        <td>${row['å¯è½‰å‚µåç¨±'] || '-'}</td>
                        <td>${row['ç”¢æ¥­'] || '-'}</td>
                        <td>${row['æ¬Šåˆ©é‡‘(ä½°å…ƒå ±åƒ¹)'] || '-'}</td>
                        <td>${row['è½‰æ›åƒ¹æ ¼'] || '-'}</td>
                        <td>${row['CBåƒè€ƒåƒ¹'] || '-'}</td>
                        <td class="${premiumClass}">${premium.toFixed(2)}%</td>
                        <td>${parseFloat(row['å‰©é¤˜å¹´æœŸ'] || 0).toFixed(2)}</td>
                        <td>${row['é¸æ“‡æ¬Šåˆ°æœŸæ—¥'] || '-'}</td>
                        <td>${row['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)'] || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadFilterOptions() {
            if (!currentData.quote) return;

            // ç”¢æ¥­é¸é …
            const industries = [...new Set(currentData.quote.map(row => row['ç”¢æ¥­']).filter(x => x))];
            const industrySelect = document.getElementById('filter-industry');
            industrySelect.innerHTML = '<option value="">å…¨éƒ¨ç”¢æ¥­</option>' + 
                industries.map(ind => `<option value="${ind}">${ind}</option>`).join('');

            // ä¿¡è©•é¸é …
            const ratings = [...new Set(currentData.quote.map(row => row['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)']).filter(x => x))];
            const ratingSelect = document.getElementById('filter-rating');
            ratingSelect.innerHTML = '<option value="">å…¨éƒ¨è©•ç­‰</option>' + 
                ratings.map(rating => `<option value="${rating}">${rating}</option>`).join('');

            loadFilterTable();
        }

        function loadFilterTable() {
            const tbody = document.getElementById('filter-tbody');
            if (!currentData.quote || currentData.quote.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">å°šæœªè¼‰å…¥è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.quote.map(row => {
                const premium = parseFloat(row['æº¢(æŠ˜)åƒ¹%']) || 0;
                const premiumClass = premium >= 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td>${row['å¯è½‰å‚µä»£ç¢¼'] || '-'}</td>
                        <td>${row['å¯è½‰å‚µåç¨±'] || '-'}</td>
                        <td>${row['ç”¢æ¥­'] || '-'}</td>
                        <td>${row['CBåƒè€ƒåƒ¹'] || '-'}</td>
                        <td>${row['è½‰æ›åƒ¹æ ¼'] || '-'}</td>
                        <td class="${premiumClass}">${premium.toFixed(2)}%</td>
                        <td>${parseFloat(row['å‰©é¤˜å¹´æœŸ'] || 0).toFixed(2)}</td>
                        <td>${row['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©%'] || '-'}</td>
                        <td>${row['è‚¡åƒ¹æ³¢å‹•ç‡240å¤©%'] || '-'}</td>
                        <td>${row['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)'] || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function applyFilters() {
            if (!currentData.quote) return;

            const industry = document.getElementById('filter-industry').value;
            const premiumMin = parseFloat(document.getElementById('filter-premium-min').value);
            const premiumMax = parseFloat(document.getElementById('filter-premium-max').value);
            const yearsMin = parseFloat(document.getElementById('filter-years-min').value);
            const yearsMax = parseFloat(document.getElementById('filter-years-max').value);
            const rating = document.getElementById('filter-rating').value;

            const filtered = currentData.quote.filter(row => {
                if (industry && row['ç”¢æ¥­'] !== industry) return false;
                
                const premium = parseFloat(row['æº¢(æŠ˜)åƒ¹%']) || 0;
                if (!isNaN(premiumMin) && premium < premiumMin) return false;
                if (!isNaN(premiumMax) && premium > premiumMax) return false;
                
                const years = parseFloat(row['å‰©é¤˜å¹´æœŸ']) || 0;
                if (!isNaN(yearsMin) && years < yearsMin) return false;
                if (!isNaN(yearsMax) && years > yearsMax) return false;
                
                if (rating && row['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)'] !== rating) return false;
                
                return true;
            });

            const tbody = document.getElementById('filter-tbody');
            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="no-data">ç„¡ç¬¦åˆæ¢ä»¶çš„è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = filtered.map(row => {
                const premium = parseFloat(row['æº¢(æŠ˜)åƒ¹%']) || 0;
                const premiumClass = premium >= 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td>${row['å¯è½‰å‚µä»£ç¢¼'] || '-'}</td>
                        <td>${row['å¯è½‰å‚µåç¨±'] || '-'}</td>
                        <td>${row['ç”¢æ¥­'] || '-'}</td>
                        <td>${row['CBåƒè€ƒåƒ¹'] || '-'}</td>
                        <td>${row['è½‰æ›åƒ¹æ ¼'] || '-'}</td>
                        <td class="${premiumClass}">${premium.toFixed(2)}%</td>
                        <td>${parseFloat(row['å‰©é¤˜å¹´æœŸ'] || 0).toFixed(2)}</td>
                        <td>${row['è‚¡åƒ¹æ³¢å‹•ç‡120å¤©%'] || '-'}</td>
                        <td>${row['è‚¡åƒ¹æ³¢å‹•ç‡240å¤©%'] || '-'}</td>
                        <td>${row['æ“”ä¿éŠ€è¡Œ/ä¿¡ç”¨è©•ç­‰(TCRI)'] || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function resetFilters() {
            document.getElementById('filter-industry').value = '';
            document.getElementById('filter-premium-min').value = '';
            document.getElementById('filter-premium-max').value = '';
            document.getElementById('filter-years-min').value = '';
            document.getElementById('filter-years-max').value = '';
            document.getElementById('filter-rating').value = '';
            loadFilterTable();
        }

        function loadRedeemTable() {
            const tbody = document.getElementById('redeem-tbody');
            if (!currentData.redeem || currentData.redeem.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">ç›®å‰ç„¡è´–å›è³‡è¨Š</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.redeem.map(row => `
                <tr>
                    <td>${row['å…¬å¸ä»£è™Ÿ'] || '-'}</td>
                    <td>${row['å…¬å¸åç¨±'] || '-'}</td>
                    <td>${row['ç”³å ±æ—¥æœŸ'] || '-'}</td>
                    <td>${row['ASOåˆ°æœŸæ—¥'] || '-'}</td>
                    <td style="max-width: 500px;">${row['ä¸»æ—¨'] || '-'}</td>
                </tr>
            `).join('');
        }

        function loadStopTable() {
            const tbody = document.getElementById('stop-tbody');
            if (!currentData.stop || currentData.stop.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">ç›®å‰ç„¡åœæ­¢è½‰æ›è³‡è¨Š</td></tr>';
                return;
            }

            // è·³éæ¨™é¡Œåˆ—
            const dataRows = currentData.stop.filter(row => row['å‚µåˆ¸ä»£ç¢¼'] && row['å‚µåˆ¸ä»£ç¢¼'] !== 'å‚µåˆ¸ä»£ç¢¼');

            if (dataRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="no-data">ç›®å‰ç„¡åœæ­¢è½‰æ›è³‡è¨Š</td></tr>';
                return;
            }

            tbody.innerHTML = dataRows.map(row => `
                <tr>
                    <td>${row['å‚µåˆ¸ä»£ç¢¼'] || '-'}</td>
                    <td>${row['å‚µåˆ¸ç°¡ç¨±'] || '-'}</td>
                    <td>${row['åœæ­¢è½‰(äº¤)æ›èµ·æ—¥'] || '-'}</td>
                    <td>${row['åœæ­¢è½‰(äº¤)æ›è¿„æ—¥'] || '-'}</td>
                    <td>${row['åœæ­¢è½‰(äº¤)æ›äº‹ç”±'] || '-'}</td>
                </tr>
            `).join('');
        }

        function loadBalanceTable() {
            const tbody = document.getElementById('balance-tbody');
            if (!currentData.balance || currentData.balance.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="no-data">å°šæœªè¼‰å…¥è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.balance.map(row => {
                const change = parseFloat(row['å¢æ¸›æ•¸é¡']) || 0;
                const changeClass = change > 0 ? 'positive' : change < 0 ? 'negative' : '';
                
                return `
                    <tr>
                        <td>${row['è­‰åˆ¸ä»£è™Ÿ'] || '-'}</td>
                        <td>${row['è­‰åˆ¸åç¨±'] || '-'}</td>
                        <td>${row['æœ¬é€±è‚¡é¡'] || '-'}</td>
                        <td>${row['ä¸Šé€±è‚¡é¡'] || '-'}</td>
                        <td class="${changeClass}">${row['å¢æ¸›æ•¸é¡'] || '0'}</td>
                        <td class="${changeClass}">${row['å¢æ¸›æ¯”ç‡'] || '0'}</td>
                        <td>${row['ç™¼è¡Œæ¯”ç‡(å‰©é¤˜æ¯”ç‡)'] || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadAdjustTable() {
            const tbody = document.getElementById('adjust-tbody');
            if (!currentData.adjust || currentData.adjust.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="no-data">ç›®å‰ç„¡åƒ¹æ ¼èª¿æ•´è³‡è¨Š</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.adjust.map(row => `
                <tr>
                    <td>${row['å…¬å¸ä»£è™Ÿ'] || '-'}</td>
                    <td>${row['å…¬å¸åç¨±'] || '-'}</td>
                    <td style="max-width: 600px;">${row['ä¸»æ—¨'] || '-'}</td>
                </tr>
            `).join('');
        }

        function loadDailyTable() {
            const tbody = document.getElementById('daily-tbody');
            if (!currentData.daily || currentData.daily.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="no-data">å°šæœªè¼‰å…¥è³‡æ–™</td></tr>';
                return;
            }

            tbody.innerHTML = currentData.daily.map(row => {
                const premium = parseFloat(row['æº¢(æŠ˜)åƒ¹%']) || 0;
                const premiumClass = premium >= 0 ? 'positive' : 'negative';
                
                return `
                    <tr>
                        <td>${row['ä»£ç¢¼'] || '-'}</td>
                        <td>${row['åç¨±  '] || '-'}</td>
                        <td>${row['ç”¢æ¥­'] || '-'}</td>
                        <td>${row['CBæ”¶ç›¤åƒ¹'] || '-'}</td>
                        <td>${row['æˆäº¤é‡'] || '-'}</td>
                        <td>${row['è‚¡åƒ¹'] || '-'}</td>
                        <td>${row['è½‰æ›åƒ¹æ ¼'] || '-'}</td>
                        <td>${row['è½‰æ›åƒ¹å€¼'] || '-'}</td>
                        <td class="${premiumClass}">${premium.toFixed(2)}%</td>
                        <td>${row['YTM'] || '-'}</td>
                        <td>${row['TCRI'] || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadPrimaryTable() {
            const tbody = document.getElementById('primary-tbody');
            if (!primaryData['ç™¼è¡Œæ¡ˆä»¶']) {
                tbody.innerHTML = '<tr><td colspan="15" class="no-data">å°šæœªè¼‰å…¥åˆç´šå¸‚å ´è³‡æ–™</td></tr>';
                return;
            }

            // éæ¿¾æ‰æ¨™é¡Œåˆ—
            const dataRows = primaryData['ç™¼è¡Œæ¡ˆä»¶'].filter((row, index) => {
                return index > 0 && row['å…ƒå¤§è­‰å‚µåˆ¸éƒ¨CBåˆç´šæ¡ˆä»¶å½™æ•´è¡¨'];
            });

            if (dataRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="15" class="no-data">ç›®å‰ç„¡é€²è¡Œä¸­çš„æ¡ˆä»¶</td></tr>';
                return;
            }

            tbody.innerHTML = dataRows.map(row => {
                const keys = Object.keys(row);
                return `
                    <tr>
                        <td>${row[keys[0]] || '-'}</td>
                        <td>${row[keys[1]] || '-'}</td>
                        <td>${row[keys[2]] || '-'}</td>
                        <td>${row[keys[3]] || '-'}</td>
                        <td>${row[keys[4]] || '-'}</td>
                        <td>${row[keys[5]] || '-'}</td>
                        <td>${row[keys[7]] || '-'}</td>
                        <td>${row[keys[8]] || '-'}</td>
                        <td>${row[keys[9]] || '-'}</td>
                        <td>${row[keys[10]] || '-'}</td>
                        <td>${row[keys[11]] || '-'}</td>
                        <td>${row[keys[13]] || '-'}</td>
                        <td>${row[keys[14]] || '-'}</td>
                        <td>${row[keys[15]] || '-'}</td>
                        <td>${row[keys[19]] || '-'}</td>
                    </tr>
                `;
            }).join('');
        }

        function loadIssuedTable() {
            const tbody = document.getElementById('issued-tbody');
            if (!primaryData['å·²ç™¼è¡Œ']) {
                tbody.innerHTML = '<tr><td colspan="14" class="no-data">å°šæœªè¼‰å…¥å·²ç™¼è¡Œè³‡æ–™</td></tr>';
                return;
            }

            const dataRows = primaryData['å·²ç™¼è¡Œ'].filter(row => row['ä»£ç¢¼']);

            if (dataRows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="14" class="no-data">ç„¡å·²ç™¼è¡Œè³‡æ–™</td></tr>';
                return;
            }

            // åªé¡¯ç¤ºæœ€è¿‘50ç­†
            const recentRows = dataRows.slice(0, 50);

            tbody.innerHTML = recentRows.map(row => `
                <tr>
                    <td>${row['ä»£ç¢¼'] || '-'}</td>
                    <td>${row['ç™¼è¡Œæ¨™çš„'] || '-'}</td>
                    <td>${row['TCRI/æ“”ä¿'] || '-'}</td>
                    <td>${row['é¡åº¦(å„„å…ƒ)'] || '-'}</td>
                    <td>${row['ä¸»è¾¦åˆ¸å•†'] || '-'}</td>
                    <td>${row['é€ä»¶æ—¥'] || '-'}</td>
                    <td>${row['ç”Ÿæ•ˆæ—¥'] || '-'}</td>
                    <td>${row['è©¢åœˆæœŸé–“'] || '-'}</td>
                    <td>${row['æº¢åƒ¹ç‡'] || '-'}</td>
                    <td>${row['è½‰æ›åƒ¹æ ¼'] || '-'}</td>
                    <td>${row['æ›ç‰Œæ—¥æœŸ'] || '-'}</td>
                    <td>${row['æ‰¿éŠ·åƒ¹æ ¼'] || '-'}</td>
                    <td>${row['å¹´æœŸ'] || '-'}</td>
                    <td>${row['è³£å›æ¢ä»¶'] || '-'}</td>
                </tr>
            `).join('');
        }

        // é é¢è¼‰å…¥æ™‚é¡¯ç¤ºæç¤º
        window.addEventListener('load', function() {
            document.getElementById('quote-tbody').innerHTML = 
                '<tr><td colspan="10" class="no-data">è«‹ä¸Šå‚³Excelæª”æ¡ˆä»¥æŸ¥çœ‹è³‡æ–™</td></tr>';
            document.getElementById('primary-tbody').innerHTML = 
                '<tr><td colspan="15" class="no-data">è«‹ä¸Šå‚³CBç™¼è¡Œæ¡ˆä»¶å½™æ•´æª”æ¡ˆä»¥æŸ¥çœ‹è³‡æ–™</td></tr>';
            document.getElementById('issued-tbody').innerHTML = 
                '<tr><td colspan="14" class="no-data">è«‹ä¸Šå‚³CBç™¼è¡Œæ¡ˆä»¶å½™æ•´æª”æ¡ˆä»¥æŸ¥çœ‹è³‡æ–™</td></tr>';
        });
    </script>
</body>
</html>
